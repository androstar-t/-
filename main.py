import streamlit as st
import pandas as pd
import plotly.express as px

# í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
st.set_page_config(
    page_title="ë°ì´í„° ë¶„ì„ ì•±",
    page_icon="ğŸ“Š",
    layout="wide"
)

# ==============================================
# í•¨ìˆ˜ ì •ì˜: ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„ ê¸°ëŠ¥
# ==============================================
def run_world_population_analysis():
    st.header("ğŸŒ ì—°ë„ë³„ ì„¸ê³„ ì¸êµ¬ ë¶„ì„")
    st.markdown("CSV íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ì—°ë„ë³„ ì„¸ê³„ ì¸êµ¬ ë¶„í¬ë¥¼ ì§€ë„ì— ì‹œê°í™”í•©ë‹ˆë‹¤.")

    # 1. ë°ì´í„° ë¡œë“œ (world_population.csv íŒŒì¼ì´ ìˆì–´ì•¼ í•¨)
    data_file = 'world_population.csv'
    try:
        df = pd.read_csv(data_file)
    except FileNotFoundError:
        st.error(f"'{data_file}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê°™ì€ í´ë”ì— ë°ì´í„° íŒŒì¼ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.")
        return
    except Exception as e:
        st.error(f"ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
        return

    # 2. ì—°ë„ ì„ íƒ ë“œëë°•ìŠ¤ ë§Œë“¤ê¸°
    # ë°ì´í„°ì—ì„œ ìœ ì¼í•œ ì—°ë„ ëª©ë¡ì„ ê°€ì ¸ì™€ ì •ë ¬
    available_years = sorted(df['year'].unique(), reverse=True)
    selected_year = st.selectbox("ë¶„ì„í•  ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”:", available_years)

    # 3. ì„ íƒí•œ ì—°ë„ë¡œ ë°ì´í„° í•„í„°ë§
    filtered_df = df[df['year'] == selected_year].copy()

    st.subheader(f"ğŸ“… {selected_year}ë…„ ì„¸ê³„ ì¸êµ¬ í˜„í™©")

    # ==============================================================================
    # í•µì‹¬ ê¸°ëŠ¥: ì¸êµ¬ìˆ˜ êµ¬ê°„ ì„¤ì • ë° ìƒ‰ìƒ ë§¤í•‘ ë¡œì§
    # ==============================================================================
    # ì¸êµ¬ ê·œëª¨ê°€ ë§¤ìš° ë‹¤ë¥´ë¯€ë¡œ ë¡œê·¸ ìŠ¤ì¼€ì¼ ëŒ€ì‹  ì´í•´í•˜ê¸° ì‰¬ìš´ ì´ì‚°ì ì¸ êµ¬ê°„(Bin)ì„ ì •ì˜í•©ë‹ˆë‹¤.
    # êµ¬ê°„ ì •ì˜: 1ì²œë§Œ ë¯¸ë§Œ, 1ì²œë§Œ~5ì²œë§Œ, 5ì²œë§Œ~1ì–µ, 1ì–µ~5ì–µ, 5ì–µ ì´ìƒ

    def categorize_population(pop):
        if pop < 10_000_000:
            return '< 1ì²œë§Œ'
        elif pop < 50_000_000:
            return '1ì²œë§Œ - 5ì²œë§Œ'
        elif pop < 100_000_000:
            return '5ì²œë§Œ - 1ì–µ'
        elif pop < 500_000_000:
            return '1ì–µ - 5ì–µ'
        else:
            return '> 5ì–µ'

    # í•„í„°ë§ëœ ë°ì´í„°í”„ë ˆì„ì— ìƒˆë¡œìš´ 'ì¸êµ¬êµ¬ê°„' ì»¬ëŸ¼ ì¶”ê°€
    filtered_df['Population_Bracket'] = filtered_df['population'].apply(categorize_population)

    # ë²”ë¡€ ìˆœì„œë¥¼ ë…¼ë¦¬ì ìœ¼ë¡œ ë§ì¶”ê¸° ìœ„í•´ ì¹´í…Œê³ ë¦¬í˜• ë°ì´í„°ë¡œ ë³€í™˜ ë° ìˆœì„œ ì§€ì •
    bracket_order = ['< 1ì²œë§Œ', '1ì²œë§Œ - 5ì²œë§Œ', '5ì²œë§Œ - 1ì–µ', '1ì–µ - 5ì–µ', '> 5ì–µ']
    filtered_df['Population_Bracket'] = pd.Categorical(
        filtered_df['Population_Bracket'], categories=bracket_order, ordered=True
    )

    # ==============================================================================
    # ì„¸ê³„ì§€ë„ ì‹œê°í™” (Plotly Express ì‚¬ìš©)
    # ==============================================================================
    # êµ¬ê°„ë³„ë¡œ ì ìš©í•  ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì •ì˜ (ì—°í•œìƒ‰ -> ì§„í•œìƒ‰)
    color_discrete_map = {
        '< 1ì²œë§Œ': '#ffffd4',      # ë§¤ìš° ì—°í•œ ë…¸ë‘
        '1ì²œë§Œ - 5ì²œë§Œ': '#fed98e', # ì—°í•œ ì£¼í™©
        '5ì²œë§Œ - 1ì–µ': '#fe9929',   # ì¤‘ê°„ ì£¼í™©
        '1ì–µ - 5ì–µ': '#d95f0e',     # ì§„í•œ ì£¼í™©/ë¹¨ê°•
        '> 5ì–µ': '#993404'        # ë§¤ìš° ì§„í•œ ë¹¨ê°•/ê°ˆìƒ‰
    }

    fig = px.choropleth(
        filtered_df,
        locations="iso_alpha",         # ISO 3ìë¦¬ êµ­ê°€ ì½”ë“œ ì‚¬ìš© (ì§€ë„ ë§¤í•‘ìš©)
        color="Population_Bracket",    # ì¸êµ¬ êµ¬ê°„ ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ ìƒ‰ì¹ 
        hover_name="country",          # ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ êµ­ê°€ëª… í‘œì‹œ
        hover_data={"population": ":,"}, # ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì¸êµ¬ìˆ˜ í‘œì‹œ (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
        color_discrete_map=color_discrete_map, # ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì ìš©
        category_orders={"Population_Bracket": bracket_order}, # ë²”ë¡€ ìˆœì„œ ê°•ì œ ì§€ì •
        projection="natural earth",    # ì§€ë„ íˆ¬ì˜ë²•
        title=f"{selected_year}ë…„ êµ­ê°€ë³„ ì¸êµ¬ ê·œëª¨"
    )

    # ì§€ë„ ë ˆì´ì•„ì›ƒ ì¡°ì • ë° í‘œì‹œ
    fig.update_layout(margin={"r":0,"t":40,"l":0,"b":0}, height=600)
    st.plotly_chart(fig, use_container_width=True)

    # (ì„ íƒì‚¬í•­) í•„í„°ë§ëœ ì›ë³¸ ë°ì´í„° í‘œì‹œ
    with st.expander(f"{selected_year}ë…„ ë°ì´í„° ë³´ê¸°"):
        st.dataframe(filtered_df.sort_values(by='population', ascending=False))


# ==============================================
# ë©”ì¸ ì•± êµ¬ì¡° (ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜)
# ==============================================

# ì‚¬ì´ë“œë°” ë©”ë‰´ êµ¬ì„±
st.sidebar.title("ë©”ë‰´")
app_mode = st.sidebar.radio(
    "ì´ë™í•  í˜ì´ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”:",
    ["í™ˆ", "ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„"] # ìš”ì²­í•˜ì‹  ë©”ë‰´ ì¶”ê°€
)

# ë©”ì¸ í™”ë©´ ë¼ìš°íŒ…
if app_mode == "í™ˆ":
    st.title("ğŸ  í™ˆ í˜ì´ì§€")
    st.write("ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ì›í•˜ëŠ” ë¶„ì„ ê¸°ëŠ¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
    st.info("ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€: 'ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„' ë©”ë‰´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")

elif app_mode == "ì—°ë„ë³„ ì„¸ê³„ì¸êµ¬ ë¶„ì„":
    # ìœ„ì—ì„œ ì •ì˜í•œ ë¶„ì„ í•¨ìˆ˜ ì‹¤í–‰
    run_world_population_analysis()
